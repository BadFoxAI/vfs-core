<!DOCTYPE html>
<html>
<head>
    <title>DRE Sovereign Terminal</title>
    <style>
        body {
            background: #111; color: #ccc; font-family: monospace; 
            margin: 0; padding: 2rem; height: 100vh; overflow: hidden;
            outline: none; font-size: 16px;
        }
        #term { white-space: pre-wrap; line-height: 1.2; }
        .blink { animation: blinker 1s linear infinite; font-weight: bold; background: #fff; color: #000; }
        @keyframes blinker { 50% { opacity: 0; } }
    </style>
</head>
<body tabindex="0" id="mainBody">
    <div id="term">Booting DRE Substrate...</div>
    <script type="module">
        import init, { init_shell, DREInstance } from './pkg/vfs_core.js';
        
        async function run() {
            await init();
            
            // 1. Run static verification suite
            let boot_html = init_shell()
                .replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;")
                .replace(/\x1B\[31m/g, '<span style="color:#ff5555; font-weight:bold;">')
                .replace(/\x1B\[32m/g, '<span style="color:#55ff55; font-weight:bold;">')
                .replace(/\x1B\[36m/g, '<span style="color:#55ffff; font-weight:bold;">')
                .replace(/\x1B\[0m/g, '</span>')
                .replace(/\n/g, '<br>');
                
            let term = document.getElementById("term");
            term.innerHTML = boot_html + "<br><span style='color: yellow;'>[ Establishing Interactive I/O Pipeline... ]</span><br><br>";
            
            // 2. Boot Interactive VM
            let dre = new DREInstance();
            let screen_buffer = "";
            document.getElementById("mainBody").focus();
            
            // Capture physical keyboard
            window.addEventListener('keydown', (e) => {
                if (e.ctrlKey || e.metaKey || e.altKey) return;
                if (e.key.length === 1) { dre.send_input(e.key.charCodeAt(0)); e.preventDefault(); }
                else if (e.key === "Enter") { dre.send_input(13); e.preventDefault(); }
                else if (e.key === "Backspace") { dre.send_input(8); e.preventDefault(); }
            });
            
            // Render Loop
            function loop() {
                dre.tick(10000); // Process VM clock cycles
                let out = dre.read_output(); // Fetch stdout
                
                if (out.length > 0) {
                    for (let i = 0; i < out.length; i++) {
                        if (out[i] === '\b') {
                            screen_buffer = screen_buffer.slice(0, -1); // Process backspace purely in UI layer
                        } else {
                            screen_buffer += out[i];
                        }
                    }
                    
                    // Handle ANSI Clear Screen
                    if (screen_buffer.includes("\x1B[2J\x1B[H")) {
                        screen_buffer = screen_buffer.split("\x1B[2J\x1B[H").pop();
                    }
                    
                    // Render ANSI Colors
                    let html = screen_buffer
                        .replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;")
                        .replace(/\x1B\[32m/g, '<span style="color:#55ff55; font-weight:bold;">')
                        .replace(/\x1B\[36m/g, '<span style="color:#55ffff; font-weight:bold;">')
                        .replace(/\x1B\[0m/g, '</span>')
                        .replace(/\n/g, '<br>');
                        
                    term.innerHTML = boot_html + "<br>" + html + "<span class='blink'>_</span>";
                    window.scrollTo(0, document.body.scrollHeight);
                }
                requestAnimationFrame(loop);
            }
            loop(); // Ignite the runtime
        }
        run();
    </script>
</body>
</html>
